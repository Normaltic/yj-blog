---
title: useSyncLocalStorage 초안
date: 2025-05-28 17:00:00
summary: 초안
---

프론트엔드를 개발하다보면, 사용자 설정이나 테마 같은 페이지를 새로 고침하거나 재접속 하더라도 유지되어야 하는 정보들을 다루게 된다.

이럴 때 가장 쉽게 활용할 수 있는 브라우저 저장소가 바로 `localStorage`이다. `localStorage`를 사용하여 특정 값을 저장하고, 재접속 시 이를 참조하여 이전 상태를 복원할 때 자주 사용된다.

`localStorage`는 영속적이고, 사용 방법도 간단해 자주 사용된다. 그래서 React에서도 `localStorage`를 활용하여 상태를 관리하는 패턴이 많이 사용된다. 하지만, React에서 `localStorage`를 사용할 때 몇 가지 문제점이 발생할 수 있다.

예를 들어, 하나의 컴포넌트에서 `localStorage`의 특정 키의 값을 업데이트 한다면 React는 이를 감지할 수 없다. `localStorage`에 저장하는 값을 상태로 다룬다고 하더라도, 다른 컴포넌트에서는 이를 알 수 없다. 그래서 동일한 키를 여러 컴포넌트에서 사용하더라도 상태가 동기화되지 않는다.

또한, 사용자가 브라저의 탭을 여러 개 열어놓고 작업하는 경우, 각 탭에서 `localStorage`의 값을 업데이트 하더라도 다른 탭에서는 이를 알 수 없다. 이로 인해 각 탭 간에 상태가 동기화되지 않아 한 탭에서 값을 변경하더라도 다른 탭에서는 이전 값을 여전히 유지하고 있을 수 있다.

이 글에서는, `localStorage`를 React의 상태와 안전하게 동기화 하고, 컴포넌트와 탭 사이의 상태를 동기화 하는 방법을 알아보려 한다. 또한, 옵션을 제공하여 추가적인 기능을 제공하는 localStorage Hook을 구현하고자 한다.

### localStorage와 React

로컬스토리지 기본 설명

리액트에서 주로 사용하는 패턴

// 코드

이를 사용해 테마나, 설정 등을 저장하고 새로고침 등이 발생했을 때에도 상태를 유지하게 만듬

매번 선언하기 번거로워서, 아래와 같은 커스텀 훅을 만들어서 사용하기도 함

// 코드

그런데 같은 키를 가지고 다른 컴포넌트에서 사용할 경우, 싱크가 안맞는 문제가 발생

한 컴포넌트에서 로컬 스토리지를 업데이트 해도, 다른 컴포넌트의 훅은 알 방법이 없음

// 작동 예제

로컬 스토리지는 다른 컴포넌트에서도 접근할 수 있는 데이터인데, 동기화가 안되면 다른 데이터를 참조하며 문제가 발생할 수 있음

제대로 사용하기 위해서는 이를 동기화 시키는 방법이 필요함

### Custome Event로 동기화하기

// 커스텀 이벤트에 대한 간단한 설명

이를 활용하면, 브라우저 내에서 각 이벤트를 리스닝하여 동기화를 시킬 수 있음

// 커스텀 이벤트 코드

// 커스텀 이벤트의 한계 및 단점

### useSyncExternalStore

useSyncExternalStore 는 리액트 18에서 어쩌구

외부의 API를 구독하여 리액트와 동기화 할 수 있음

// useSyncExternalStore 에 대한 간단한 코드

이를 활용하면 로컬 스토리지의 값을 구독할 수 있도록 만들 수 있다

// 프리미티브 타입의 useSyncExternalStore 코드

그런데 localStorage 반환값이 객체인 경우에는 `getSnapshot`이 항상 새 값을 반환한다.

그러면 리렌더링 시 매번 새 값을 반환하게 되며, 리액트에서 에러가 발생한다.

// 에러 메세지

이를 위해, 상태값을 비교할 수 있는 함수를 전달하도록 하자.

// isEqual 전달 및 구현 내용

적용

// 작동 예제

이를 통해 리액트가 지원하는 방식으로 localStorage를 구독하며 각 훅들이 값을 공유할 수 있게 만들 수 있다.

그런데 로컬 스토리지는 새로 고침하거나 재접속을 해도 유지될 뿐만 아니라, 각 탭들 사이에서도 값이 공유되어 참조할 수 있다.

하지만, 브라우저의 탭을 여러 개 열어놓고 작업하는 경우, 각 탭에서 `localStorage`의 값을 업데이트 하더라도 다른 탭에서는 이를 알 수 없다. 그래서 복수개의 탭을 열어놓고 작업을 할 경우, 각 탭 간에 상태가 동기화되지 않아 한 탭에서 값을 변경하더라도 다른 탭에서는 이전 값을 여전히 유지하고 있을 수 있다.

이럴 땐 `storage` 이벤트를 사용해볼 수 있다.

### Window storage event

// 스토리지 이벤트에 대한 설명

스토리지 이벤트는 동일 탭에는 전달되지 않고, 다른 윈도우에 전달되는 이벤트이다.

이를 활용하면 다른 윈도우 끼리 통신하여, `localStorage`의 변화를 감지하고 상태를 동기화할 수 있다

// 스토리지 코드 예제

// 작동 예제

### useSyncLocalStorage

앞 섹션들에서 다루었던 useSyncExternalStore와 storage이벤트를 활용한다면, 컴포넌트들 뿐만 아니라 다른 윈도우 사이에서도 동기화를 진행할 수 있겠다.

이를 합쳐서 구현해보자

// 합쳐서 구현한 코드

// 작동 예제

이제 `localStorage`와 상태를 안전하게 동기화 하고, Hook을 사용하는 컴포넌트들 뿐만 아니라 브라우저의 탭들 사이에서도 동기화가 잘 이루어지는 Hook이 되었다.

### 추가 구현

현재 `useSyncLocalStorage`는 동기화 기능을 제공한다. 여기에 추가적인 기능을 제공하여 더 유용하게 만들어보자.

#### 타입가드

로컬 스토리지에 저장되는 값은 문자열이고, JSON.parse가 반환하는 결과물은 any타입이다. 그래서 타입이 안정적이지 않다.

타입 가드를 넣어 안정적으로 사용할 수 있도록 해보자.

// 타입 가드 코드

타입 검증에 실패하면 `console.error`를 출력하도록 했다. `localStorage`는 사용자가 직접 값을 수정할 수도 있기 때문에, 무작정 `Error`를 발생시키기 보다는 메세지를 출력하고, 기본 값을 반환하도록 했다.

그래서 `localStorage`에서 불러올 때에는 타입 검증에 실패하면 기본 값을 반환하도록 하고, `storage`이벤트로 전달 되는 값은 타입 검증에 실패하면 기존 컴포넌트의 상태를 반환하도록 한다.

타입 검증에 실패하면 에러를 출력하는 것을 확인할 수 있다.

// 작동 예제

이제 타입가드를 통해 `localStorage`에서 반환되는 값의 타입을 신뢰할 수 있게 되었다.

#### serialize, deserialize

Map, Set 같은 클래스는 stringify를 하면 빈 객체(`'{}'`)가 된다. 그리고 `toString`을 하면 `'[object Map]'` 같은 문자열이 된다. 그래서 JSON.stringify를 사용하면 제대로 직렬화되지 않고, 그 상태로 JSON.parse를 하면 원본 자료형을 복원할 수 없다.

이를 해결하기 위해, serialize와 deserialize 옵션을 제공하여 다양한 자료형을 지원할 수 있도록 하자.

// serialize, deserialize 코드

// 작동 코드

이를 통해, 이제 기본 자료형 뿐 아니라 Map, Set, Date 등 다양한 자료형을 `localStorage`에 저장하고 불러올 수 있게 되었다.

### 결과

지금까지 구현한 `useSyncLocalStorage` 훅의 기능 명세는 다음과 같다:

- 기능1
- 기능2
- 기능3
- 기능4

`useSyncLocalStorage` 전체 코드는 이렇게 구성되었다.

// useSyncLocalStorage 전체 코드

이는 다음과 같은 방식으로 사용할 수 있게 되었다.

// 사용 방법

### 마무리

이 글은 사이드프로젝트를 진행하는 도중 `localStorage`를 사용할 일이 있었는데, 컴포넌트간 동기화를 어떻게 고민하다가 생각을 정리하기 위해 작성하게 되었다.

사실, [이전 블로그 글](https://blog.yunji.kim/react_global_state_without_library)은 이 고민을 하면서 `useSyncExternalStore`를 접하게 되어서 작성한 글이고, 이를 작성하면서 `useSyncExternalStore`에 익숙해져 해당 글을 잘 정리할 수 있게 되었다.

이 글을 통해 `localStorage`를 React의 상태와 안전하게 동기화하고, 컴포넌트와 탭 사이의 상태를 동기화하는 방법을 알아보았다. 또한, 추가적인 기능을 제공하는 `useSyncLocalStorage` 훅을 구현하여 다양한 자료형을 지원할 수 있게 되었다.

이전 글에서도 그랬는데, 생각보다 괜찮은 결과물이 나오게 되었다고 생각한다. 다음에 `localStorage`를 사용할 일이 있다면, 이 글의 경험을 바탕으로 해당 Hook을 활용할 수 있는 기회가 있으면 좋겠다.
